/**
 * Created by thana on 9/15/2016.
 */

Template.contours.viewmodel({
    displayedContour() {
        return {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "relativeGain": -0.5,
                        "beam": "",
                        "category": "A"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [
                                    117.019,
                                    -31.866
                                ],
                                [
                                    117.113,
                                    -32.273
                                ],
                                [
                                    117.136,
                                    -32.527
                                ],
                                [
                                    117.103,
                                    -32.6
                                ],
                                [
                                    116.492,
                                    -33.199
                                ],
                                [
                                    116.46,
                                    -33.214
                                ],
                                [
                                    116.374,
                                    -33.2
                                ],
                                [
                                    115.845,
                                    -33.007
                                ],
                                [
                                    115.598,
                                    -32.537
                                ],
                                [
                                    115.721,
                                    -31.874
                                ],
                                [
                                    115.908,
                                    -31.664
                                ],
                                [
                                    116.525,
                                    -31.511
                                ],
                                [
                                    117.019,
                                    -31.866
                                ]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "relativeGain": -1,
                        "beam": "",
                        "category": "A"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [
                                    116.748,
                                    -31.214
                                ],
                                [
                                    117.136,
                                    -31.49
                                ],
                                [
                                    117.364,
                                    -31.865
                                ],
                                [
                                    117.431,
                                    -32.526
                                ],
                                [
                                    117.13,
                                    -33.196
                                ],
                                [
                                    117.083,
                                    -33.243
                                ],
                                [
                                    116.447,
                                    -33.533
                                ],
                                [
                                    115.824,
                                    -33.438
                                ],
                                [
                                    115.546,
                                    -33.206
                                ],
                                [
                                    115.244,
                                    -32.603
                                ],
                                [
                                    115.227,
                                    -32.54
                                ],
                                [
                                    115.262,
                                    -32.276
                                ],
                                [
                                    115.335,
                                    -31.877
                                ],
                                [
                                    115.92,
                                    -31.219
                                ],
                                [
                                    115.928,
                                    -31.214
                                ],
                                [
                                    116.54,
                                    -31.127
                                ],
                                [
                                    116.748,
                                    -31.214
                                ]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "relativeGain": -1.5,
                        "beam": "",
                        "category": "B"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [
                                    117.24,
                                    -31.212
                                ],
                                [
                                    117.635,
                                    -31.864
                                ],
                                [
                                    117.71,
                                    -32.525
                                ],
                                [
                                    117.429,
                                    -33.195
                                ],
                                [
                                    117.073,
                                    -33.554
                                ],
                                [
                                    116.434,
                                    -33.837
                                ],
                                [
                                    115.809,
                                    -33.751
                                ],
                                [
                                    115.208,
                                    -33.252
                                ],
                                [
                                    115.18,
                                    -33.209
                                ],
                                [
                                    115.001,
                                    -32.542
                                ],
                                [
                                    115.088,
                                    -31.879
                                ],
                                [
                                    115.305,
                                    -31.481
                                ],
                                [
                                    115.535,
                                    -31.222
                                ],
                                [
                                    115.939,
                                    -30.961
                                ],
                                [
                                    116.549,
                                    -30.877
                                ],
                                [
                                    117.147,
                                    -31.122
                                ],
                                [
                                    117.24,
                                    -31.212
                                ]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "relativeGain": -2,
                        "beam": "",
                        "category": "B"

                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [
                                    117.502,
                                    -31.21
                                ],
                                [
                                    117.744,
                                    -31.612
                                ],
                                [
                                    117.849,
                                    -31.863
                                ],
                                [
                                    117.907,
                                    -32.524
                                ],
                                [
                                    117.711,
                                    -33.193
                                ],
                                [
                                    117.707,
                                    -33.199
                                ],
                                [
                                    117.063,
                                    -33.848
                                ],
                                [
                                    117.007,
                                    -33.873
                                ],
                                [
                                    116.425,
                                    -34.059
                                ],
                                [
                                    115.796,
                                    -34.005
                                ],
                                [
                                    115.568,
                                    -33.883
                                ],
                                [
                                    115.189,
                                    -33.576
                                ],
                                [
                                    114.955,
                                    -33.211
                                ],
                                [
                                    114.788,
                                    -32.544
                                ],
                                [
                                    114.873,
                                    -31.881
                                ],
                                [
                                    115.225,
                                    -31.224
                                ],
                                [
                                    115.323,
                                    -31.119
                                ],
                                [
                                    115.949,
                                    -30.722
                                ],
                                [
                                    116.557,
                                    -30.642
                                ],
                                [
                                    117.154,
                                    -30.877
                                ],
                                [
                                    117.502,
                                    -31.21
                                ]
                            ]
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "relativeGain": -2.5,
                        "beam": "",
                        "category": "C"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [
                            [
                                [
                                    116.952,
                                    -30.566
                                ],
                                [
                                    117.161,
                                    -30.648
                                ],
                                [
                                    117.748,
                                    -31.21
                                ],
                                [
                                    117.752,
                                    -31.216
                                ],
                                [
                                    118.025,
                                    -31.863
                                ],
                                [
                                    118.089,
                                    -32.523
                                ],
                                [
                                    117.91,
                                    -33.193
                                ],
                                [
                                    117.7,
                                    -33.505
                                ],
                                [
                                    117.336,
                                    -33.872
                                ],
                                [
                                    117.056,
                                    -34.059
                                ],
                                [
                                    116.416,
                                    -34.259
                                ],
                                [
                                    115.785,
                                    -34.214
                                ],
                                [
                                    115.175,
                                    -33.886
                                ],
                                [
                                    115.171,
                                    -33.883
                                ],
                                [
                                    114.743,
                                    -33.213
                                ],
                                [
                                    114.618,
                                    -32.687
                                ],
                                [
                                    114.593,
                                    -32.545
                                ],
                                [
                                    114.667,
                                    -31.908
                                ],
                                [
                                    114.67,
                                    -31.883
                                ],
                                [
                                    115.008,
                                    -31.226
                                ],
                                [
                                    115.336,
                                    -30.878
                                ],
                                [
                                    115.829,
                                    -30.572
                                ],
                                [
                                    115.958,
                                    -30.512
                                ],
                                [
                                    116.564,
                                    -30.448
                                ],
                                [
                                    116.952,
                                    -30.566
                                ]
                            ]
                        ]
                    }
                }
            ]
        }
    },
    satellites: [
        { id: 'A', name: 'Thaicom 4' },
        { id: 'B', name: 'Thaicom 5' },
        { id: 'C', name: 'Thaicom 6' },
    ],
    selectedSatellite: '',
    selectedValueToDisplay: '',
    selectedValueType: '',
    contours: '',
    contourSubmitted(event) {
        event.preventDefault();

        let satellite = this.selectedSatellite();
        let parameter = this.selectedValueToDisplay();
        let valueType = this.selectedValueType();
        let contours = convertContoursTableToObject(this.contours());

        if (!satellite) {
            Bert.alert('Please select a satellite', 'danger', 'fixed-top');
        }
        else if (!parameter) {
            Bert.alert('Please select either EIRP or G/T', 'danger', 'fixed-top');
        }
        else if (!valueType) {
            Bert.alert('Please select either absolute value or relative from peak value', 'danger', 'fixed-top');
        }
        else if (!contours) {
            Bert.alert('Please put contours in the correct format', 'danger', 'fixed-top');
        }

        else {
            let newContour = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {
                            "relativeGain": -0.5,
                            "beam": "",
                            "category": "A"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [
                                [
                                    [
                                        117.019,
                                        -31.866
                                    ],
                                    [
                                        117.113,
                                        -32.273
                                    ],
                                    [
                                        117.136,
                                        -32.527
                                    ],
                                    [
                                        117.103,
                                        -32.6
                                    ],
                                    [
                                        116.492,
                                        -33.199
                                    ],
                                    [
                                        116.46,
                                        -33.214
                                    ],
                                    [
                                        116.374,
                                        -33.2
                                    ],
                                    [
                                        115.845,
                                        -33.007
                                    ],
                                    [
                                        115.598,
                                        -32.537
                                    ],
                                    [
                                        115.721,
                                        -31.874
                                    ],
                                    [
                                        115.908,
                                        -31.664
                                    ],
                                    [
                                        116.525,
                                        -31.511
                                    ],
                                    [
                                        117.019,
                                        -31.866
                                    ]
                                ]
                            ]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "relativeGain": -1,
                            "beam": "",
                            "category": "A"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [
                                [
                                    [
                                        116.748,
                                        -31.214
                                    ],
                                    [
                                        117.136,
                                        -31.49
                                    ],
                                    [
                                        117.364,
                                        -31.865
                                    ],
                                    [
                                        117.431,
                                        -32.526
                                    ],
                                    [
                                        117.13,
                                        -33.196
                                    ],
                                    [
                                        117.083,
                                        -33.243
                                    ],
                                    [
                                        116.447,
                                        -33.533
                                    ],
                                    [
                                        115.824,
                                        -33.438
                                    ],
                                    [
                                        115.546,
                                        -33.206
                                    ],
                                    [
                                        115.244,
                                        -32.603
                                    ],
                                    [
                                        115.227,
                                        -32.54
                                    ],
                                    [
                                        115.262,
                                        -32.276
                                    ],
                                    [
                                        115.335,
                                        -31.877
                                    ],
                                    [
                                        115.92,
                                        -31.219
                                    ],
                                    [
                                        115.928,
                                        -31.214
                                    ],
                                    [
                                        116.54,
                                        -31.127
                                    ],
                                    [
                                        116.748,
                                        -31.214
                                    ]
                                ]
                            ]
                        }
                    },
                ]
            };
            let options = {
                satellite: satellite,
                parameter: parameter,
                valueType: valueType,
                contours: contours,
            };
            Meteor.call('findContoursToPlot', options, (error, result) => {
                if (error) {
                    Bert.alert(error.reason, 'danger', 'fixed-top');
                }
                else {
                    $('.map-container').empty();
                    Blaze.renderWithData(Template.geojsonPreview, {
                        geojsonData: result,
                    }, $('.map-container')[0]);
                }
            });

        }

        function convertContoursTableToObject(contours) {
            console.log(contours);
            let rows = contours.split('\n');
            console.log('rows = ' + rows);
            let formattedContours = [];

            // Remove the last row if it is blank. This happens when paste from excel and the cursor enter a new line
            if (rows[rows.length-1].length == 0) {
                rows.pop();
            }
            rows.forEach((row) => {
                let columns = row.split('\t');

                if (columns.length < 2 || columns.length > 3) {
                    return false;
                }
                let contourLine = {};

                // 1st column = beam name
                if (!columns[0]) return false;
                contourLine.name = columns[0];

                // 2nd column = path (fwd, rtn) for HTS, = value for conventional
                if (columns.length == 3) { // HTS
                    let path = columns[1].toLowerCase();
                    console.log('Path = ' + path);
                    if(!_.contains(['forward','return','fwd','rtn'], path)) {
                        return false;
                    }
                    contourLine.path = path;

                    let value = columns[2];
                    if(isNaN(value)) {
                        return false;
                    }
                    contourLine.value = +value;
                }

                // 2nd column = path (fwd, rtn) for HTS, = value for conventional
                if (columns.length == 2) { // Conventional
                    let value = columns[1];
                    if(isNaN(value)) {
                        return false;
                    }
                    contourLine.value = +value;
                }
                formattedContours.push(contourLine);
            });
            return formattedContours;
        }


    },
});